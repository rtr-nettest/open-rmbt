name: Build RTR-NetztestCLI (without testing)

on: [push]

jobs:
  build-linux-x64:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history and tags
    - name: set up JDK 1.21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'corretto'
    - name: Build with Gradle
      run: |
        ./gradlew :RMBTClient:shadowJar -x test
    - name: Archive jar
      uses: actions/upload-artifact@v4
      with:
        name: RTR-NetztestCLI-jar
        path: |
          RMBTClient/build/libs/*-all.jar
        retention-days: 90
    - name: Build jpackage
      run: |
        mkdir -p RMBTClient/build
        cp RMBTClient/icon/rtr-netztest.png RMBTClient/build
        cd RMBTClient/build/
        ls *
        # Get the initial commit hash
        INITIAL_COMMIT=$(git rev-list --max-parents=0 HEAD)
        # Count commits since the initial commit
        version_tag=$(git rev-list --count ${INITIAL_COMMIT}..HEAD)
        jpackage --input libs --name "RTR-Netztest" --icon rtr-netztest.png --main-jar RMBTClient-all.jar  --main-class at.rtr.rmbt.client.RMBTClientRunner --type app-image --app-version "$version_tag"  --vendor "RTR" --verbose --arguments --log  --description "RTR-Netztest - RMBTClient engine"
        ls *
        zip -r RTR-NetztestCLI-linux-x64.zip RTR-Netztest 
    - name: Archive files linux
      uses: actions/upload-artifact@v4
      with:
        name: RTR-NetztestCLI-linux-x64
        path: |
          RMBTClient/build/RTR-Netztest/*
        retention-days: 90

  build-macos:

    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history and tags
    - name: set up JDK 1.21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'corretto'
    - name: Build with Gradle
      run: |
        ./gradlew :RMBTClient:shadowJar -x test
    - name: Build jpackage
      run: |
        cp RMBTClient/icon/rtr-netztest.icns RMBTClient/build
        cd RMBTClient/build/
        ls *
        pwd
        # Get the initial commit hash
        INITIAL_COMMIT=$(git rev-list --max-parents=0 HEAD)
        # Count commits since the initial commit
        version_tag=$(git rev-list --count ${INITIAL_COMMIT}..HEAD)
        jpackage --input libs --name "RTR-Netztest" --icon rtr-netztest.icns --main-jar RMBTClient-all.jar  --main-class at.rtr.rmbt.client.RMBTClientRunner --type app-image --app-version "$version_tag"  --vendor "RTR" --verbose --arguments --log  --description "RTR-Netztest - RMBTClient engine"
        ls *
        zip -r RTR-NetztestCLI-macos.zip RTR-Netztest.app
    - name: Archive files macos
      uses: actions/upload-artifact@v4
      with:
        name: RTR-NetztestCLI-macos
        path: |
          RMBTClient/build/RTR-Netztest.app/*
        retention-days: 90

  build-win:

    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history and tags
    - name: set up JDK 1.21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    - name: Build with Gradle
      run: |
        dir
        .\gradlew.bat build --info --stacktrace :RMBTClient:shadowJar -x test
    - name: Build jpackage
      run: |
        copy RMBTClient\icon\rtr-netztest.ico RMBTClient\build
        cd RMBTClient\build\
        dir *
        # Get the initial commit hash
        $INITIAL_COMMIT = git rev-list --max-parents=0 HEAD
        # Count commits since the initial commit
        $versionTag = git rev-list --count "$INITIAL_COMMIT..HEAD"
        Write-Output "Number of commits since the initial commit: $versionTag"
        jpackage --input libs/ --name "RTR-Netztest" --icon rtr-netztest.ico --main-jar RMBTClient-all.jar  --main-class at.rtr.rmbt.client.RMBTClientRunner --type app-image --app-version "$versionTag"  --vendor "RTR" --verbose --arguments --log --description "RTR-Netztest - RMBTClient engine"
        dir *
        Compress-Archive -Path RTR-Netztest -DestinationPath RTR-NetztestCLI-win32.zip 
    - name: Archive files win
      uses: actions/upload-artifact@v4
      with:
        name: RTR-NetztestCLI-win32
        path: |
          RMBTClient/build/RTR-Netztest/*
        retention-days: 90


  create_release:
    runs-on: ubuntu-latest
    needs: [build-win, build-linux-x64, build-macos]
    steps:
      - name: Download Windows Artifacts
        uses: actions/download-artifact@v4
        with:
          name: RTR-NetztestCLI-win32
          path: windows

      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: RTR-NetztestCLI-linux-x64
          path: linux

      - name: Download macos Artifacts
        uses: actions/download-artifact@v4
        with:
          name: RTR-NetztestCLI-macos
          path: macos

      - name: Zip artifacts again
        run: |
          cd linux
          zip -r ../RTR-NetztestCLI-linux-x64.zip .
          cd ../windows
          zip -r ../RTR-NetztestCLI-win32.zip .
          cd ../macos
          zip -r ../RTR-NetztestCLI-macos.zip .
          cd ..
          
          
      - name: List Files for Debugging
        run: |
          echo "Listing files in linux"
          ls -R linux
          echo "Listing files in windows"
          ls -R windows
          echo "Listing files in macos"
          ls -R macos

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag'
        with:
          files: |
            linux/lib/app/RMBTClient-all.jar
            RTR-NetztestCLI-linux-x64.zip
            RTR-NetztestCLI-win32.zip
            RTR-NetztestCLI-macos.zip        
          token: ${{ secrets.GITHUB_TOKEN }}
